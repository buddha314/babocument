# Babylon.js Client Structure - Comprehensive Guide

## Project Overview

**Babocument** is an immersive VR/XR document management platform built with Babylon.js and Next.js. The client is responsible for rendering a 3D virtual file room for navigating research documents through time.

**Current Status:** Foundation phase with basic scene rendering and physics simulation

---

## 1. Directory Structure

```
client/
├── src/
│   ├── app/
│   │   ├── layout.tsx          # Root layout (Next.js)
│   │   ├── page.tsx            # Main Babylon scene component
│   │   ├── favicon.ico
│   │   └── globals.css
│   ├── scripts/
│   │   └── box.ts              # Example script - mesh rotation
│   └── scripts.ts              # Script registry (auto-generated)
├── assets/
│   ├── example.scene/          # BabylonJS Editor scene export
│   │   ├── config.json         # Scene configuration
│   │   ├── cameras/            # Camera definitions
│   │   ├── lights/             # Light definitions
│   │   ├── meshes/             # Mesh definitions
│   │   ├── geometries/         # Geometry binary data
│   │   ├── shadowGenerators/   # Shadow configurations
│   │   └── preview.png         # Scene preview
│   ├── *.env                   # Environment textures (HDR)
│   ├── *.material              # Material definitions
│   └── *.png/.jpg              # Texture assets
├── public/                     # Static assets (served at /)
├── package.json                # Dependencies and scripts
├── tsconfig.json               # TypeScript configuration
├── next.config.js              # Next.js configuration
├── tailwind.config.ts          # Tailwind CSS configuration
└── postcss.config.js           # PostCSS configuration
```

---

## 2. Key Files Overview

### 2.1 Main Scene Component (src/app/page.tsx)

**Purpose:** Root React component that initializes and manages the Babylon.js scene

**Key Responsibilities:**
- Creates and configures Engine
- Creates Scene with physics
- Loads Havok physics plugin
- Loads scene from babylon editor export
- Runs render loop
- Manages component lifecycle

### 2.2 Script Registry (src/scripts.ts)

**Purpose:** Registers all scene scripts for babylonjs-editor-tools loader

Auto-generated by BabylonJS Editor when exporting scenes

### 2.3 Example Script (src/scripts/box.ts)

**Purpose:** Example script attached to a mesh - demonstrates rotation animation

Pattern to follow for new scripts

### 2.4 Scene Configuration (assets/example.scene/config.json)

Contains:
- Camera definitions
- Light configurations
- Mesh definitions
- Material references
- Physics settings
- Environment settings
- Shadow generators

---

## 3. Scene Initialization Flow

```
page.tsx Component Mount
    -> Create Engine with Canvas
    -> Create Scene
    -> Initialize Physics Engine (Havok)
    -> Load Scene from "example.babylon"
    -> Attach Active Camera Control
    -> Start Render Loop
    -> Render Loop: scene.render() each frame
```

---

## 4. Current Babylon.js Imports

The client imports:

Core:
- Scene, Engine, Vector3
- SceneLoaderFlags, HavokPlugin

Loading:
- loadingScreen, babylonFileLoader

Cameras:
- universalCamera

Physics:
- HavokPlugin, Physics v2

Graphics:
- groundMesh, PBR/standardMaterial

Lighting:
- directionalLight, shadowGeneratorSceneComponent

Rendering:
- depthRendererSceneComponent, prePassRendererSceneComponent

XR Features:
- WebXRDepthSensing (imported but not used)

Materials:
- sky material

---

## 5. Engine Configuration

Current Engine Options:
- stencil: true
- antialias: true
- audioEngine: true
- adaptToDeviceRatio: true
- disableWebGL2Support: false
- useHighPrecisionFloats: true
- powerPreference: "high-performance"
- failIfMajorPerformanceCaveat: false

---

## 6. Physics System

Type: Havok Physics Engine v2
Gravity: (0, -981, 0) - Standard Earth gravity

---

## 7. Package Dependencies

Babylon.js Packages:
- @babylonjs/core: 8.33.2
- @babylonjs/gui: 8.33.2
- @babylonjs/havok: 1.3.10
- @babylonjs/materials: 8.33.2
- babylonjs-editor-tools: latest

Other:
- next: 14.2.32
- react: ^18
- typescript: 5.8.3
- tailwindcss: 3.3.0

---

## 8. Key Integration Points for WebXR Plugins

1. Scene Initialization (in handleLoad function)
   - Where to create WebXRExperienceHelper
   - Where to request XR session

2. Engine Options
   - Already optimized for XR with stencil buffer, high precision floats

3. Script Pattern
   - Scripts follow IScript interface compatible with WebXR

4. Physics Integration
   - Can work with WebXR controllers and physics

---

## 9. WebXR Modules to Import

Core WebXR:
- WebXRExperienceHelper
- WebXRMotionControllerTeleportation
- WebXRControllerPointerSelection
- WebXRPlanes
- WebXRHitTest
- WebXRDOMOverlay

Hand Tracking (optional):
- WebXRHandTracking

Feature Managers:
- WebXRFeaturePointSystem

---

## 10. Files to Modify for WebXR

1. src/app/page.tsx
   - Add WebXR setup and feature imports
   - Initialize WebXRExperienceHelper in handleLoad

2. src/scripts.ts
   - Register new XR-related scripts

3. src/scripts/*.ts
   - Add WebXR interaction handlers

4. package.json
   - Verify @babylonjs/* packages are sufficient

5. next.config.js
   - May need updates for XR shaders

---

## 11. Asset Structure

Location: client/assets/

Contents:
- example.scene/ - BabylonJS Editor exported scene
- country.env - HDR environment texture (3.8MB)
- *.material - Material definitions
- *.png/*.jpg - Texture assets

Scene Structure:
- 3 meshes (example scene objects)
- 1 directional light with shadows
- 1 camera
- Physics-enabled meshes

---

## 12. Development Workflow

Local Development:
```bash
cd client
npm install
npm run dev
# Visit http://localhost:3000
```

---

## 13. Current Limitations

Missing:
- Scene files in public/ folder (only in assets/)
- No WebXR feature initialization
- No XR interaction handlers
- No motion controller support
- No hand tracking support

Available Optimizations:
- LOD (Level of Detail) system not used
- Frustum culling available
- Shadow map optimization
- Texture compression options

---

## 14. Next Steps for WebXR Integration

1. Import WebXR modules in page.tsx
2. Create WebXR helper in handleLoad function
3. Add feature detection for supported XR features
4. Create interaction scripts for controller/hand input
5. Add fallback for non-XR browsers
6. Test on target XR devices

---

Last Updated: 2025-11-06
Babylon.js Version: 8.33.2
Next.js Version: 14.2.32
